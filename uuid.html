<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUID Collision Detector</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            text-align: center;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 2rem;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .uuid-display {
            font-size: 1.5rem;
            padding: 2rem;
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid #00ff00;
            border-radius: 10px;
            margin-bottom: 2rem;
            word-break: break-all;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat {
            background: rgba(0, 255, 0, 0.05);
            padding: 1rem;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 1rem 2rem;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            background: #00ff00;
            color: #0a0a0a;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        button:hover {
            background: #00cc00;
            transform: scale(1.05);
        }
        
        button.stop {
            background: #ff0000;
            color: white;
        }
        
        button.stop:hover {
            background: #cc0000;
        }
        
        .collision-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: flash 0.5s infinite;
        }
        
        .collision-alert.active {
            display: flex;
        }
        
        .collision-content {
            text-align: center;
            color: white;
            padding: 2rem;
        }
        
        .collision-content h2 {
            font-size: 4rem;
            margin-bottom: 2rem;
            animation: pulse 0.5s infinite;
        }
        
        .collision-content .matched-uuid {
            font-size: 2rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 2rem;
            border-radius: 10px;
            margin: 2rem 0;
            word-break: break-all;
        }
        
        .collision-content .probability {
            font-size: 1.5rem;
            margin-top: 1rem;
        }
        
        @keyframes flash {
            0%, 100% { background: rgba(255, 0, 0, 0.95); }
            50% { background: rgba(255, 100, 0, 0.95); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .memory-warning {
            color: #ffaa00;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        
        .bloom-info {
            color: #00aaff;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .warning {
            color: #00ff00;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>UUID COLLISION DETECTOR</h1>
        
        <div class="uuid-display" id="currentUuid">Initializing IndexedDB...</div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Generated (Total)</div>
                <div class="stat-value" id="generated">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Stored in DB</div>
                <div class="stat-value" id="stored">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Cache Size</div>
                <div class="stat-value" id="cacheSize">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Rate (per sec)</div>
                <div class="stat-value" id="rate">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Collision Chance</div>
                <div class="stat-value" id="probability">~0%</div>
            </div>
            <div class="stat">
                <div class="stat-label">DB Queries</div>
                <div class="stat-value" id="queries">0</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn" onclick="start()" disabled>INITIALIZING...</button>
            <button id="stopBtn" class="stop" onclick="stop()" style="display:none;">STOP</button>
            <button onclick="reset()">RESET</button>
        </div>
        
        <div class="memory-warning">
            Using IndexedDB - stores UNLIMITED UUIDs on disk!
        </div>
        <div class="bloom-info">
            <span class="warning">âœ“ 100% accurate collision detection across ALL UUIDs forever</span>
        </div>
    </div>
    
    <div class="collision-alert" id="collisionAlert">
        <div class="collision-content">
            <h2>ðŸš¨ COLLISION DETECTED! ðŸš¨</h2>
            <div>IMPOSSIBLE EVENT OCCURRED!</div>
            <div class="matched-uuid" id="matchedUuid"></div>
            <div class="probability" id="collisionProb"></div>
        </div>
    </div>
    
    <audio id="alarmSound" loop>
        <source src="https://audio-previews.elements.envatousercontent.com/files/173153038/preview.mp3?response-content-disposition=attachment%3B+filename%3D%22NBUK26X-alarm.mp3%22" type="audio/mpeg">
    </audio>
    
    <script>
        let db = null;
        let generated = 0;
        let dbCount = 0;
        let queryCount = 0;
        let isRunning = false;
        let intervalId = null;
        let lastRateUpdate = 0;
        let lastGenCount = 0;
        
        // In-memory cache for fast lookup
        const memoryCache = new Set();
        const CACHE_SIZE = 100000; // Keep 100k recent UUIDs in memory
        
        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('UUIDCollisionDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    console.log('IndexedDB initialized');
                    resolve(db);
                };
                
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('uuids')) {
                        database.createObjectStore('uuids', { keyPath: 'id' });
                    }
                };
            });
        }
        
        // Check if UUID exists in DB
        async function checkUUIDExists(uuid) {
            // First check memory cache (super fast)
            if (memoryCache.has(uuid)) {
                return true;
            }
            
            // Then check IndexedDB
            return new Promise((resolve, reject) => {
                queryCount++;
                const transaction = db.transaction(['uuids'], 'readonly');
                const store = transaction.objectStore('uuids');
                const request = store.get(uuid);
                
                request.onsuccess = () => {
                    resolve(request.result !== undefined);
                };
                request.onerror = () => reject(request.error);
            });
        }
        
        // Add UUID to DB
        async function addUUID(uuid) {
            // Add to memory cache
            memoryCache.add(uuid);
            
            // Manage cache size
            if (memoryCache.size > CACHE_SIZE) {
                const arr = Array.from(memoryCache);
                memoryCache.clear();
                arr.slice(-CACHE_SIZE).forEach(u => memoryCache.add(u));
            }
            
            // Add to IndexedDB
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['uuids'], 'readwrite');
                const store = transaction.objectStore('uuids');
                const request = store.add({ id: uuid });
                
                request.onsuccess = () => {
                    dbCount++;
                    resolve();
                };
                request.onerror = () => {
                    // Might fail if key already exists, that's ok
                    resolve();
                };
            });
        }
        
        // Get count from DB
        async function getDBCount() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['uuids'], 'readonly');
                const store = transaction.objectStore('uuids');
                const request = store.count();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function calculateProbability(n) {
            const totalUUIDs = Math.pow(2, 122);
            const prob = 1 - Math.exp(-(n * (n - 1)) / (2 * totalUUIDs));
            
            if (prob < 1e-10) return '~0%';
            if (prob < 1e-6) return `~${(prob * 100).toExponential(2)}%`;
            return `${(prob * 100).toFixed(10)}%`;
        }
        
        function triggerCollision(uuid) {
            const alert = document.getElementById('collisionAlert');
            const audio = document.getElementById('alarmSound');
            
            document.getElementById('matchedUuid').textContent = uuid;
            document.getElementById('collisionProb').textContent = 
                `Probability at ${generated.toLocaleString()} UUIDs: ${calculateProbability(generated)}`;
            
            alert.classList.add('active');
            audio.volume = 1.0;
            
            stop();
            
            console.log('ðŸš¨ COLLISION DETECTED! ðŸš¨', uuid);
        }
        
        async function generateBatch() {
            const batchSize = 100;
            const batch = [];
            
            for (let i = 0; i < batchSize; i++) {
                const uuid = generateUUID();
                
                // Check if we've seen this UUID before
                const exists = await checkUUIDExists(uuid);
                
                if (exists) {
                    // REAL COLLISION!
                    triggerCollision(uuid);
                    return;
                }
                
                batch.push(uuid);
                generated++;
                
                document.getElementById('currentUuid').textContent = uuid;
            }
            
            // Add batch to DB
            for (const uuid of batch) {
                await addUUID(uuid);
            }
            
            // Update stats
            document.getElementById('generated').textContent = generated.toLocaleString();
            document.getElementById('stored').textContent = dbCount.toLocaleString();
            document.getElementById('cacheSize').textContent = memoryCache.size.toLocaleString();
            document.getElementById('queries').textContent = queryCount.toLocaleString();
            document.getElementById('probability').textContent = calculateProbability(generated);
            
            // Update rate (every second)
            const now = Date.now();
            if (now - lastRateUpdate > 1000) {
                const rate = Math.round((generated - lastGenCount) * 1000 / (now - lastRateUpdate));
                document.getElementById('rate').textContent = rate.toLocaleString();
                lastRateUpdate = now;
                lastGenCount = generated;
            }
            
            // Periodically update DB count
            if (generated % 10000 === 0) {
                dbCount = await getDBCount();
            }
        }
        
        function start() {
            if (isRunning || !db) return;
            
            isRunning = true;
            lastRateUpdate = Date.now();
            lastGenCount = generated;
            
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // Start playing alarm (muted) so it's ready
            const audio = document.getElementById('alarmSound');
            audio.volume = 0;
            audio.play().catch(e => console.log('Audio autoplay blocked - will work on collision'));
            
            intervalId = setInterval(generateBatch, 10);
        }
        
        function stop() {
            if (!isRunning) return;
            
            isRunning = false;
            clearInterval(intervalId);
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            
            const audio = document.getElementById('alarmSound');
            audio.pause();
            audio.volume = 0;
        }
        
        async function reset() {
            stop();
            
            if (db) {
                // Clear the database
                const transaction = db.transaction(['uuids'], 'readwrite');
                const store = transaction.objectStore('uuids');
                await store.clear();
            }
            
            memoryCache.clear();
            generated = 0;
            dbCount = 0;
            queryCount = 0;
            lastGenCount = 0;
            
            document.getElementById('currentUuid').textContent = 'Waiting to start...';
            document.getElementById('generated').textContent = '0';
            document.getElementById('stored').textContent = '0';
            document.getElementById('cacheSize').textContent = '0';
            document.getElementById('queries').textContent = '0';
            document.getElementById('rate').textContent = '0';
            document.getElementById('probability').textContent = '~0%';
            document.getElementById('collisionAlert').classList.remove('active');
            
            const audio = document.getElementById('alarmSound');
            audio.pause();
            audio.currentTime = 0;
            audio.volume = 0;
        }
        
        // Prevent closing without confirmation
        let userChoice = null;
        
        window.addEventListener('beforeunload', (e) => {
            if (generated > 0) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
        
        // Show custom modal on unload
        window.addEventListener('unload', async (e) => {
            if (userChoice === 'delete') {
                // Clear database
                if (db) {
                    const transaction = db.transaction(['uuids'], 'readwrite');
                    const store = transaction.objectStore('uuids');
                    await store.clear();
                }
            }
        });
        
        // Initialize on load
        (async () => {
            try {
                await initDB();
                dbCount = await getDBCount();
                document.getElementById('stored').textContent = dbCount.toLocaleString();
                document.getElementById('currentUuid').textContent = 'Ready! Database loaded.';
                document.getElementById('startBtn').textContent = 'START';
                document.getElementById('startBtn').disabled = false;
            } catch (err) {
                console.error('Failed to initialize IndexedDB:', err);
                document.getElementById('currentUuid').textContent = 'ERROR: IndexedDB failed to initialize';
            }
        })();
    </script>
</body>
</html>
