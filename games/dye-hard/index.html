
<!DOCTYPE html>
<html lang="en-us">

<head>
  <script src="./famobi-game-interface.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover' />

  
  
  
  <title>Dye Hard</title>
  <style>
    * {
      padding: 0;
      margin: 0;
    }

    html {
      /* fix mobile viewport menu bar on iOS */
      height: -webkit-fill-available;
    }

    body {
      height: 100%;
      /* fix mobile viewport menu bar on iOS */
      height: -webkit-fill-available;
      width: 100%;
      text-align: center;
    }

    #unity-container {
      position: absolute;
      left: 0px;
      top: 0px;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Default values, might be overwritten by aspect ratio media queries */
    #unity-canvas {
      width: 100%;
      height: 100%;
      background-color: #fff;
    }



    #unity-loading-container {
      position: absolute;
      left: 0px;
      top: 0px;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 40px;

      opacity: 1;
      visibility: visible;
      transition: 800ms linear;
    }

    #unity-loading-container.finished {
      opacity: 0;
      visibility: collapse;
    }

    #unity-loading-container .logo {
      width: 15%;
      height: 15%;
    }

    #unity-loading-bar {
      position: relative;
      width: 40%;
      height: 10px;
      background-color: #fff;
      border: 1px solid #aaa;
      border-radius: 10px;
    }

    #unity-loading-bar-inner {
      position: absolute;
      left: 0%;
      top: 0%;
      width: 1%;
      height: 100%;
      background-color: #ccc;
      border-radius: 10px;
      transition: 400ms linear;
    }
	
	#x_unity-loading-bar {
      position: relative;
      width: 40%;
      height: 5px;
      background-color: #555;
      border: 1px solid #000;
      border-radius: 5px;
    }

    #x_unity-loading-bar-inner {
      position: absolute;
      left: 0%;
      top: 0%;
      width: 1%;
      height: 100%;
      background-color: #fff;
      border-radius: 5px;
      transition: 400ms linear;
    }
  </style>
</head>

<body>

  <script>
	(function(){
	  const ua = navigator.userAgent;
	  const isSafari = /^((?!chrome|android).)*safari/i.test(ua);

	  // Условие: если это Safari — НЕ добавляем preload
	  if (!isSafari) {
		const links = [
		  { href: "Build/Build.data.unityweb", as: "fetch", type:"application/octet-stream", crossorigin:true },
		  { href: "Build/Build.wasm.unityweb", as: "fetch", type:"application/wasm", crossorigin:true }
		];
		links.forEach(d => {
		  const l = document.createElement("link");
		  l.rel = "preload"; l.href = d.href; l.as = d.as;
		  if (d.type) l.type = d.type;
		  if (d.crossorigin) l.crossOrigin = "";
		  document.head.appendChild(l);
		});
	  }
	})();
	</script>

  <div id="unity-container">
    <canvas id="unity-canvas"></canvas>
  </div>
  <div id="unity-loading-container">
    <div id="unity-loading-bar">
      <div id="unity-loading-bar-inner"></div>
    </div>
  </div>
  
  <div id="x_ovl" style="width:100%; height:100%;position: absolute; background-color: #000; display: flex; flex-direction: column; align-items: center; justify-content: center;">
	<img src="logo.webp" width="384" height="384">
	<div id="x_unity-loading-bar">
      <div id="x_unity-loading-bar-inner"></div>
    </div>
  </div>
  
  <script>
    window.GameInterface.init(["Build/Build.loader.js", async function() {
		var buildUrl = "Build";
		var loaderUrl = buildUrl + "/Build.loader.js";
		var config = {
		  dataUrl: buildUrl + "/Build.data.unityweb",
		  frameworkUrl: buildUrl + "/Build.framework.js.unityweb",
		  codeUrl: buildUrl + "/Build.wasm.unityweb",
		  streamingAssetsUrl: "StreamingAssets",
		  companyName: "Flexus",
		  productName: "Dye Hard",
		  productVersion: "0.10.6",
		};

		var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
		if(isMobile) {
		  // Define a maximum pixel ratio for mobile to avoid rendering at too high resolutions
		  const maxPixelRatioMobile = 2.0;
		  config.devicePixelRatio = Math.min(window.devicePixelRatio, maxPixelRatioMobile);
		}

		var canvas = document.querySelector("#unity-canvas");
		var loadingContainer = document.querySelector("#unity-loading-container");
		var loadingBar = document.querySelector("#unity-loading-bar-inner");
		
		//const url = "Localization.json";
		//try {
			//const response = await fetch(url);
			//if (response.ok) {
				//const str = await response.text();
				//window.LocalizationData = str;
			//}
		//} catch (error) {}

		var unityGame;
		var script = document.createElement("script");
		script.src = loaderUrl;
		script.onload = function() {
		  //let prevProgress = -1;
		  createUnityInstance(canvas, config, function(progress) {
			loadingBar.style.width = 100 * progress + "%";
			//let curProgress = 100 * progress;
			//if (curProgress != prevProgress) window.GameInterface.sendPreloadProgress(curProgress);
			//prevProgress = curProgress;
		  }).then(function(unityInstance) {
			unityGame = unityInstance;
			loadingContainer.classList.add("finished");
		  }).catch(function(message) {
			alert(message);
		  });
		};
		document.body.appendChild(script);
	}]).then(result => {
      // start the game...
    });
	
	window.GameInterface.onOffsetChange(offsets => {
		let unityCont = document.getElementById("unity-container");
		unityCont.style.width = 'auto';
		unityCont.style.height = 'auto';
		unityCont.style.left = offsets.left + "px";
		unityCont.style.top = offsets.top + "px";
		unityCont.style.right = offsets.right + "px";
		unityCont.style.bottom = offsets.bottom + "px";
	});
	
	var ended = false;
	var curMaxPerc = 80;
	requestAnimationFrame(updt);
	window.onGameStarted = function () {
		document.getElementById("x_ovl").remove();
		ended = true;
		
		window.GameInterface.sendPreloadProgress(100);
	}
	
	let prevProgress = -1;
	let numFramesPercCorrect = 0;
	function updt() {
		let perc = Number(document.getElementById("unity-loading-bar-inner").style.width.replace("%", ""));
		if (perc == 90 && numFramesPercCorrect < 30) {
			numFramesPercCorrect++;
			perc = 0;
		}
		else if (perc > 0 && perc != 90 && numFramesPercCorrect < 30) {
			numFramesPercCorrect = 100;
		}
		if (perc >= 99.9) {
			perc = curMaxPerc;
			curMaxPerc += 0.03;
			if (curMaxPerc > 98) curMaxPerc = 98;
		}
		else perc = perc * 0.8;
		
		let curProgress = Math.floor(perc);
		if (!ended && curProgress != prevProgress && window.GameInterface !== undefined && window.GameInterface.sendPreloadProgress !== undefined) window.GameInterface.sendPreloadProgress(curProgress);
		prevProgress = curProgress;
	
		if (!ended) document.getElementById("x_unity-loading-bar-inner").style.width = perc + "%";
		if (!ended) requestAnimationFrame(updt);
	}
  </script>
  
</body>
</html>
